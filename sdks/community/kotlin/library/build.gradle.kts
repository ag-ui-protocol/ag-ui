// Root build script for AG-UI-4K multiplatform library
// All modules are configured individually - see each module's build.gradle.kts

plugins {
    kotlin("multiplatform") version "2.2.20" apply false
    kotlin("plugin.serialization") version "2.2.20" apply false
    id("com.android.library") version "8.10.1" apply false
    id("org.jetbrains.dokka") version "2.0.0"
    id("org.jetbrains.kotlinx.kover") version "0.8.3"
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

// Configure all subprojects with common settings
subprojects {
    group = "com.agui"
    version = "0.2.3"

    apply(plugin = "org.jetbrains.kotlinx.kover")
    
    tasks.withType<Test> {
        useJUnitPlatform()
    }
    
    // Apply Dokka to all subprojects
    apply(plugin = "org.jetbrains.dokka")
}

// Simple Dokka V2 configuration - let it use defaults for navigation

tasks.register("koverHtmlReportAll") {
    group = "verification"
    description = "Generates HTML coverage reports for all library modules."
    dependsOn(subprojects.map { "${it.path}:koverHtmlReport" })
}

// Create a task to generate unified documentation
tasks.register("dokkaHtmlMultiModule") {
    dependsOn(subprojects.map { "${it.name}:dokkaGenerate" })
    group = "documentation"
    description = "Generate unified HTML documentation for all modules"
    
    doLast {
        val outputDir = layout.buildDirectory.dir("dokka/htmlMultiModule").get().asFile
        outputDir.mkdirs()
        
        // Create master index.html
        val indexContent = """
<!DOCTYPE html>
<html>
<head>
    <title>AG-UI-4K Documentation</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 2rem; }
        .module { margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
        .module h2 { margin-top: 0; color: #2563eb; }
        .module a { text-decoration: none; color: #2563eb; font-weight: 500; }
        .module a:hover { text-decoration: underline; }
        .description { color: #6b7280; margin: 0.5rem 0; }
    </style>
</head>
<body>
    <h1>AG-UI-4K Library Documentation</h1>
    <p>Welcome to the AG-UI-4K Kotlin Multiplatform library for building AI agent user interfaces.</p>
    
    <div class="module">
        <h2><a href="core/index.html">core</a></h2>
        <p class="description">Core types, events, and protocol definitions for the AG-UI protocol</p>
    </div>
    
    <div class="module">
        <h2><a href="client/index.html">client</a></h2>
        <p class="description">Client implementations, HTTP transport, SSE parsing, state management, and high-level agent SDKs</p>
    </div>
    
    <div class="module">
        <h2><a href="tools/index.html">tools</a></h2>
        <p class="description">Tool system, error handling, circuit breakers, and execution management</p>
    </div>
    
    <p style="margin-top: 2rem; color: #6b7280; font-size: 0.9rem;">
        Generated by Dokka from KDoc comments
    </p>
</body>
</html>
        """.trimIndent()
        
        val indexFile = outputDir.resolve("index.html")
        indexFile.writeText(indexContent)
        
        // Copy individual module documentation
        subprojects.forEach { project ->
            val moduleDocsDir = project.layout.buildDirectory.dir("dokka/html").get().asFile
            if (moduleDocsDir.exists()) {
                val targetDir = outputDir.resolve(project.name)
                moduleDocsDir.copyRecursively(targetDir, overwrite = true)
            }
        }
        
        println("Unified documentation generated at: ${outputDir.absolutePath}/index.html")
    }
}
