{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { AbstractAgent, RunAgentResult } from \"@ag-ui/client\";\nimport { AgentConfig, RunAgentParameters } from \"@ag-ui/client\";\nimport { RunAgentInput, BaseEvent, EventType } from \"@ag-ui/core\";\nimport { Observable } from \"rxjs\";\nimport { AgentSubscriber } from \"@ag-ui/client\";\n\ninterface CloudflareAgentsConfig extends AgentConfig {\n  url: string;\n}\n\ninterface RunCloudflareAgentConfig extends RunAgentParameters {\n  abortController?: AbortController;\n}\n\n/**\n * Cloudflare Agents AG-UI connector\n * Connects to a Cloudflare Worker running the Agents SDK via WebSocket\n */\nexport class CloudflareAgentsAgent extends AbstractAgent {\n  public url: string;\n  private ws: WebSocket | null = null;\n  public abortController: AbortController = new AbortController();\n\n  constructor(config: CloudflareAgentsConfig) {\n    super(config);\n    this.url = config.url;\n  }\n\n  public runAgent(\n    parameters?: RunCloudflareAgentConfig,\n    subscriber?: AgentSubscriber,\n  ): Promise<RunAgentResult> {\n    this.abortController = parameters?.abortController ?? new AbortController();\n    return super.runAgent(parameters, subscriber);\n  }\n\n  abortRun() {\n    if (this.ws) {\n      this.ws.close();\n      this.ws = null;\n    }\n    this.abortController.abort();\n    super.abortRun();\n  }\n\n  run(input: RunAgentInput): Observable<BaseEvent> {\n    return new Observable<BaseEvent>((observer) => {\n      const wsUrl = this.url.replace(/^http/, \"ws\");\n      this.ws = new WebSocket(wsUrl);\n\n      this.ws.onopen = () => {\n        // Send the AG-UI input to the Cloudflare Agent\n        const message = input.messages?.[0];\n        if (message && \"content\" in message && typeof message.content === \"string\") {\n          this.ws?.send(message.content);\n        }\n      };\n\n      this.ws.onmessage = (event) => {\n        try {\n          const cloudflareEvent = JSON.parse(event.data);\n\n          // Transform Cloudflare Agent events to AG-UI events\n          const agEvent = this.transformEvent(cloudflareEvent);\n          if (agEvent) {\n            observer.next(agEvent);\n          }\n        } catch (err) {\n          observer.error(err);\n        }\n      };\n\n      this.ws.onerror = (error) => {\n        observer.error(error);\n      };\n\n      this.ws.onclose = () => {\n        observer.complete();\n      };\n\n      return () => {\n        if (this.ws) {\n          this.ws.close();\n          this.ws = null;\n        }\n      };\n    });\n  }\n\n  private transformEvent(cloudflareEvent: any): BaseEvent | null {\n    // Map Cloudflare Agent events to AG-UI events\n    switch (cloudflareEvent.type) {\n      case \"RUN_STARTED\":\n        return {\n          type: EventType.RUN_STARTED,\n          run_id: cloudflareEvent.run_id,\n          thread_id: cloudflareEvent.thread_id,\n        };\n\n      case \"TEXT_MESSAGE_START\":\n        return {\n          type: EventType.TEXT_MESSAGE_START,\n          run_id: cloudflareEvent.run_id,\n          role: cloudflareEvent.role,\n        };\n\n      case \"TEXT_MESSAGE_CONTENT\":\n        return {\n          type: EventType.TEXT_MESSAGE_CONTENT,\n          run_id: cloudflareEvent.run_id,\n          delta: cloudflareEvent.delta,\n        };\n\n      case \"TEXT_MESSAGE_END\":\n        return {\n          type: EventType.TEXT_MESSAGE_END,\n          run_id: cloudflareEvent.run_id,\n        };\n\n      case \"RUN_FINISHED\":\n        return {\n          type: EventType.RUN_FINISHED,\n          run_id: cloudflareEvent.run_id,\n        };\n\n      case \"READY\":\n        // Ignore handshake events\n        return null;\n\n      default:\n        console.warn(\"Unknown Cloudflare Agent event type:\", cloudflareEvent.type);\n        return null;\n    }\n  }\n\n  public clone(): CloudflareAgentsAgent {\n    const cloned = super.clone() as CloudflareAgentsAgent;\n    cloned.url = this.url;\n\n    const newController = new AbortController();\n    const originalSignal = this.abortController.signal as AbortSignal & { reason?: unknown };\n    if (originalSignal.aborted) {\n      newController.abort(originalSignal.reason);\n    }\n    cloned.abortController = newController;\n\n    return cloned;\n  }\n}\n"],"mappings":";AAAA,SAAS,qBAAqC;AAE9C,SAAmC,iBAAiB;AACpD,SAAS,kBAAkB;AAepB,IAAM,wBAAN,cAAoC,cAAc;AAAA,EAKvD,YAAY,QAAgC;AAC1C,UAAM,MAAM;AAJd,SAAQ,KAAuB;AAC/B,SAAO,kBAAmC,IAAI,gBAAgB;AAI5D,SAAK,MAAM,OAAO;AAAA,EACpB;AAAA,EAEO,SACL,YACA,YACyB;AA/B7B;AAgCI,SAAK,mBAAkB,8CAAY,oBAAZ,YAA+B,IAAI,gBAAgB;AAC1E,WAAO,MAAM,SAAS,YAAY,UAAU;AAAA,EAC9C;AAAA,EAEA,WAAW;AACT,QAAI,KAAK,IAAI;AACX,WAAK,GAAG,MAAM;AACd,WAAK,KAAK;AAAA,IACZ;AACA,SAAK,gBAAgB,MAAM;AAC3B,UAAM,SAAS;AAAA,EACjB;AAAA,EAEA,IAAI,OAA6C;AAC/C,WAAO,IAAI,WAAsB,CAAC,aAAa;AAC7C,YAAM,QAAQ,KAAK,IAAI,QAAQ,SAAS,IAAI;AAC5C,WAAK,KAAK,IAAI,UAAU,KAAK;AAE7B,WAAK,GAAG,SAAS,MAAM;AAlD7B;AAoDQ,cAAM,WAAU,WAAM,aAAN,mBAAiB;AACjC,YAAI,WAAW,aAAa,WAAW,OAAO,QAAQ,YAAY,UAAU;AAC1E,qBAAK,OAAL,mBAAS,KAAK,QAAQ;AAAA,QACxB;AAAA,MACF;AAEA,WAAK,GAAG,YAAY,CAAC,UAAU;AAC7B,YAAI;AACF,gBAAM,kBAAkB,KAAK,MAAM,MAAM,IAAI;AAG7C,gBAAM,UAAU,KAAK,eAAe,eAAe;AACnD,cAAI,SAAS;AACX,qBAAS,KAAK,OAAO;AAAA,UACvB;AAAA,QACF,SAAS,KAAK;AACZ,mBAAS,MAAM,GAAG;AAAA,QACpB;AAAA,MACF;AAEA,WAAK,GAAG,UAAU,CAAC,UAAU;AAC3B,iBAAS,MAAM,KAAK;AAAA,MACtB;AAEA,WAAK,GAAG,UAAU,MAAM;AACtB,iBAAS,SAAS;AAAA,MACpB;AAEA,aAAO,MAAM;AACX,YAAI,KAAK,IAAI;AACX,eAAK,GAAG,MAAM;AACd,eAAK,KAAK;AAAA,QACZ;AAAA,MACF;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEQ,eAAe,iBAAwC;AAE7D,YAAQ,gBAAgB,MAAM;AAAA,MAC5B,KAAK;AACH,eAAO;AAAA,UACL,MAAM,UAAU;AAAA,UAChB,QAAQ,gBAAgB;AAAA,UACxB,WAAW,gBAAgB;AAAA,QAC7B;AAAA,MAEF,KAAK;AACH,eAAO;AAAA,UACL,MAAM,UAAU;AAAA,UAChB,QAAQ,gBAAgB;AAAA,UACxB,MAAM,gBAAgB;AAAA,QACxB;AAAA,MAEF,KAAK;AACH,eAAO;AAAA,UACL,MAAM,UAAU;AAAA,UAChB,QAAQ,gBAAgB;AAAA,UACxB,OAAO,gBAAgB;AAAA,QACzB;AAAA,MAEF,KAAK;AACH,eAAO;AAAA,UACL,MAAM,UAAU;AAAA,UAChB,QAAQ,gBAAgB;AAAA,QAC1B;AAAA,MAEF,KAAK;AACH,eAAO;AAAA,UACL,MAAM,UAAU;AAAA,UAChB,QAAQ,gBAAgB;AAAA,QAC1B;AAAA,MAEF,KAAK;AAEH,eAAO;AAAA,MAET;AACE,gBAAQ,KAAK,wCAAwC,gBAAgB,IAAI;AACzE,eAAO;AAAA,IACX;AAAA,EACF;AAAA,EAEO,QAA+B;AACpC,UAAM,SAAS,MAAM,MAAM;AAC3B,WAAO,MAAM,KAAK;AAElB,UAAM,gBAAgB,IAAI,gBAAgB;AAC1C,UAAM,iBAAiB,KAAK,gBAAgB;AAC5C,QAAI,eAAe,SAAS;AAC1B,oBAAc,MAAM,eAAe,MAAM;AAAA,IAC3C;AACA,WAAO,kBAAkB;AAEzB,WAAO;AAAA,EACT;AACF;","names":[]}