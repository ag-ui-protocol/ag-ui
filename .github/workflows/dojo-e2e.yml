name: e2e

on:
  push:
    branches: [main]
    paths:
      - "integrations/**"
      - "apps/dojo/**"
      - "middlewares/**"
      - "pnpm-lock.yaml"
      - "pnpm-workspace.yaml"
      - ".github/workflows/dojo-e2e.yml"
      - "sdks/python/**"
      - "sdks/typescript/**"
  pull_request:
    branches: [main]
    paths:
      - "apps/dojo/**"
      - "integrations/**"
      - "middlewares/**"
      - "pnpm-lock.yaml"
      - "pnpm-workspace.yaml"
      - ".github/workflows/dojo-e2e.yml"
      - "sdks/python/**"
      - "sdks/typescript/**"

jobs:
  check-generated-files:
    name: dojo / check-generated-files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: Validate agentFilesMapper and regenerate files.json
        working-directory: apps/dojo
        run: pnpm generate-content-json

      - name: Check files.json is up to date
        working-directory: apps/dojo
        run: |
          if git diff --exit-code src/files.json > /dev/null; then
            echo "✅ No changes detected in dojo/src/files.json. Everything is up to date."
          else
            echo "❌ Detected changes in dojo/src/files.json."
            echo ""
            echo "The committed files.json doesn't match what would be generated."
            echo "Please run \`(p)npm run generate-content-json\` in the apps/dojo folder and commit the updated file."
            echo ""
            echo "The detected diff was as follows:"
            echo "::group::Diff for dojo/src/files.json"
            git diff src/files.json
            echo "::endgroup::"
            exit 1
          fi

  dojo:
    name: dojo / ${{ matrix.suite }}
    needs: check-generated-files
    runs-on: depot-ubuntu-24.04
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - suite: a2a-middleware
            test_path: tests/a2aMiddlewareTests
            wait_on: http://localhost:9999,tcp:localhost:8011,tcp:localhost:8012,tcp:localhost:8013,tcp:localhost:8014
            install_cmd: cd middlewares/a2a-middleware/examples && uv sync
            server_cmd: |
              (cd middlewares/a2a-middleware/examples && PORT=8011 uv run buildings_management.py) &
              (cd middlewares/a2a-middleware/examples && PORT=8012 uv run finance.py) &
              (cd middlewares/a2a-middleware/examples && PORT=8013 uv run it.py) &
              cd middlewares/a2a-middleware/examples && PORT=8014 uv run orchestrator.py
            needs_langgraph_env: false
          - suite: adk-middleware
            test_path: tests/adkMiddlewareTests
            wait_on: http://localhost:9999,tcp:localhost:8010
            install_cmd: cd integrations/adk-middleware/python/examples && uv sync
            server_cmd: cd integrations/adk-middleware/python/examples && PORT=8010 uv run dev
            needs_langgraph_env: false
          - suite: agno
            test_path: tests/agnoTests
            wait_on: http://localhost:9999,tcp:localhost:8002
            install_cmd: cd integrations/agno/python/examples && uv sync
            server_cmd: cd integrations/agno/python/examples && PORT=8002 uv run dev
            needs_langgraph_env: false
          - suite: crew-ai
            test_path: tests/crewAITests
            wait_on: http://localhost:9999,tcp:localhost:8003
            install_cmd: cd integrations/crew-ai/python && poetry install
            server_cmd: cd integrations/crew-ai/python && PORT=8003 poetry run dev
            needs_langgraph_env: false
          - suite: langgraph-fastapi
            test_path: tests/langgraphFastAPITests
            wait_on: http://localhost:9999,tcp:localhost:8004
            install_cmd: cd integrations/langgraph/python/examples && POETRY_VIRTUALENVS_IN_PROJECT=false poetry install
            server_cmd: cd integrations/langgraph/python/examples && POETRY_VIRTUALENVS_IN_PROJECT=false PORT=8004 poetry run dev
            needs_langgraph_env: true
          - suite: langgraph-python
            test_path: tests/langgraphPythonTests
            wait_on: http://localhost:9999,tcp:localhost:8005
            install_cmd: ""
            server_cmd: cd integrations/langgraph/python/examples && pnpx @langchain/langgraph-cli@latest dev --no-browser --host 127.0.0.1 --port 8005
            needs_langgraph_env: true
          - suite: langgraph-typescript
            test_path: tests/langgraphTypescriptTests
            wait_on: http://localhost:9999,tcp:localhost:8006
            install_cmd: cd integrations/langgraph/typescript/examples && pnpm install
            server_cmd: cd integrations/langgraph/typescript/examples && pnpx @langchain/langgraph-cli@latest dev --no-browser --host 127.0.0.1 --port 8006
            needs_langgraph_env: true
          - suite: llama-index
            test_path: tests/llamaIndexTests
            wait_on: http://localhost:9999,tcp:localhost:8007
            install_cmd: cd integrations/llama-index/python/examples && uv sync
            server_cmd: cd integrations/llama-index/python/examples && PORT=8007 uv run dev
            needs_langgraph_env: false
          - suite: mastra
            test_path: tests/mastraTests
            wait_on: http://localhost:9999,tcp:localhost:8008
            install_cmd: cd integrations/mastra/typescript/examples && pnpm install --no-frozen-lockfile
            server_cmd: cd integrations/mastra/typescript/examples && PORT=8008 npm run dev
            needs_langgraph_env: false
          - suite: mastra-agent-local
            test_path: tests/mastraAgentLocalTests
            wait_on: http://localhost:9999
            install_cmd: ""
            server_cmd: wait
            needs_langgraph_env: false
          - suite: middleware-starter
            test_path: tests/middlewareStarterTests
            wait_on: http://localhost:9999
            install_cmd: ""
            server_cmd: wait
            needs_langgraph_env: false
          - suite: pydantic-ai
            test_path: tests/pydanticAITests
            wait_on: http://localhost:9999,tcp:localhost:8009
            install_cmd: cd integrations/pydantic-ai/python/examples && uv sync
            server_cmd: cd integrations/pydantic-ai/python/examples && PORT=8009 uv run dev
            needs_langgraph_env: false
          - suite: server-starter
            test_path: tests/serverStarterTests
            wait_on: http://localhost:9999,tcp:localhost:8000
            install_cmd: cd integrations/server-starter/python/examples && poetry install
            server_cmd: cd integrations/server-starter/python/examples && PORT=8000 poetry run dev
            needs_langgraph_env: false
          - suite: server-starter-all
            test_path: tests/serverStarterAllFeaturesTests
            wait_on: http://localhost:9999,tcp:localhost:8001
            install_cmd: cd integrations/server-starter-all-features/python/examples && poetry install
            server_cmd: cd integrations/server-starter-all-features/python/examples && PORT=8001 poetry run dev
            needs_langgraph_env: false
          - suite: aws-strands
            test_path: tests/awsStrandsTests
            wait_on: http://localhost:9999,tcp:localhost:8017
            install_cmd: cd integrations/aws-strands/python/examples && poetry install
            server_cmd: cd integrations/aws-strands/python/examples && PORT=8017 poetry run dev
            needs_langgraph_env: false
          # - suite: vercel-ai-sdk
          #   test_path: tests/vercelAISdkTests
          #   wait_on: http://localhost:9999
          #   install_cmd: ""
          #   server_cmd: wait
          #   needs_langgraph_env: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      # Now that pnpm is available, cache its store to speed installs
      - name: Resolve pnpm store path
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # Cache Python tool caches and virtualenvs; restore only to avoid long saves
      - name: Cache Python dependencies (restore-only)
        id: cache-python
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
            ~/.cache/uv
            **/.venv
          key: ${{ runner.os }}-pydeps-${{ hashFiles('**/poetry.lock', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pydeps-

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm run build

      - name: Verify dojo build
        run: |
          if [ ! -d "apps/dojo/.next" ]; then
            echo "::warning::.next directory missing after global build, building demo-viewer explicitly"
            npx nx run demo-viewer:build
          else
            echo "✅ .next directory exists"
          fi

      - name: Install integration dependencies
        if: ${{ matrix.install_cmd != '' }}
        run: ${{ matrix.install_cmd }}

      - name: Install e2e dependencies
        working-directory: apps/dojo/e2e
        run: pnpm install

      - name: Write langgraph env files
        if: ${{ matrix.needs_langgraph_env == true }}
        working-directory: integrations/langgraph
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
        run: |
          echo "OPENAI_API_KEY=${OPENAI_API_KEY}" > python/examples/.env
          echo "LANGSMITH_API_KEY=${LANGSMITH_API_KEY}" >> python/examples/.env
          echo "OPENAI_API_KEY=${OPENAI_API_KEY}" > typescript/examples/.env
          echo "LANGSMITH_API_KEY=${LANGSMITH_API_KEY}" >> typescript/examples/.env

      - name: Write startup script
        env:
          SERVER_CMD: ${{ matrix.server_cmd }}
        run: |
          cat > /tmp/start-services.sh << 'DOJO_EOF'
          #!/usr/bin/env bash
          set -m

          export PORT=9999
          export SERVER_STARTER_URL=http://localhost:8000
          export SERVER_STARTER_ALL_FEATURES_URL=http://localhost:8001
          export AGNO_URL=http://localhost:8002
          export CREW_AI_URL=http://localhost:8003
          export LANGGRAPH_FAST_API_URL=http://localhost:8004
          export LANGGRAPH_PYTHON_URL=http://localhost:8005
          export LANGGRAPH_TYPESCRIPT_URL=http://localhost:8006
          export LLAMA_INDEX_URL=http://localhost:8007
          export MASTRA_URL=http://localhost:8008
          export PYDANTIC_AI_URL=http://localhost:8009
          export ADK_MIDDLEWARE_URL=http://localhost:8010
          export A2A_MIDDLEWARE_BUILDINGS_MANAGEMENT_URL=http://localhost:8011
          export A2A_MIDDLEWARE_FINANCE_URL=http://localhost:8012
          export A2A_MIDDLEWARE_IT_URL=http://localhost:8013
          export A2A_MIDDLEWARE_ORCHESTRATOR_URL=http://localhost:8014
          export AWS_STRANDS_URL=http://localhost:8017
          export NEXT_PUBLIC_CUSTOM_DOMAIN_TITLE='cpkdojo.local___CopilotKit Feature Viewer'

          echo "::group::Starting dojo"
          (cd apps/dojo && pnpm run start) &
          DOJO_PID=$!
          echo "Dojo PID: $DOJO_PID"
          echo "::endgroup::"
          DOJO_EOF

          # Append server command from env var (preserves newlines)
          if [ "$SERVER_CMD" != "wait" ] && [ -n "$SERVER_CMD" ]; then
            echo "" >> /tmp/start-services.sh
            echo "echo '::group::Starting integration server'" >> /tmp/start-services.sh
            echo "$SERVER_CMD" >> /tmp/start-services.sh
            echo "echo '::endgroup::'" >> /tmp/start-services.sh
          fi

          echo "" >> /tmp/start-services.sh
          echo "wait" >> /tmp/start-services.sh

          chmod +x /tmp/start-services.sh
          echo "--- Generated startup script ---"
          cat /tmp/start-services.sh
          echo "--- End startup script ---"

      - name: Start services
        uses: JarvusInnovations/background-action@v1
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        with:
          run: bash /tmp/start-services.sh
          wait-on: ${{ matrix.wait_on }}
          wait-for: 300000

      - name: Run tests – ${{ matrix.suite }}
        working-directory: apps/dojo/e2e
        env:
          BASE_URL: http://localhost:9999
          PLAYWRIGHT_SUITE: ${{ matrix.suite }}
        run: |
          pnpm test -- ${{ matrix.test_path }}

      - name: Upload traces – ${{ matrix.suite }}
        if: always() # Uploads artifacts even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.suite }}-playwright-traces
          path: |
            apps/dojo/e2e/test-results/${{ matrix.suite }}/**/*
            apps/dojo/e2e/playwright-report/**/*
          retention-days: 7
